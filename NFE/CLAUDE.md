# üìã MIGRA√á√ÉO MDFe FlexDocs ‚Üí ACBrLib - Documenta√ß√£o Completa

## üìë √çNDICE
1. [Status Atual](#status-atual)
2. [Etapa 1 - Teste SuperMDFe](#etapa-1)
3. [Pr√≥ximas Etapas](#proximas-etapas)
4. [Estrutura do Banco](#estrutura-banco)
5. [Arquivos ACBr](#arquivos-acbr)
6. [C√≥digo - Antes/Depois](#codigo)
7. [Testes](#testes)
8. [Chamadas FlexDocs](#chamadas-flexdocs)
9. [Regras Cr√≠ticas](#regras-criticas)
10. [Informa√ß√µes T√©cnicas](#info-tecnicas)

---

## üöß STATUS ATUAL {#status-atual}

### üìä STATUS ATUAL (Janeiro 2025):
- ‚úÖ **ETAPA 1 CONCLU√çDA COM SUCESSO!** 
- ‚úÖ **ACBr inicializado, INI gerado, XML criado (1157 chars), dados salvos no banco**
- ‚úÖ **Problema "Bad DLL calling convention" RESOLVIDO**
- üìã **PR√ìXIMO PASSO**: Etapa 2 - Transmiss√£o do MDFe

---

## üéØ ETAPA 1 - TESTE SuperMDFe() {#etapa-1}
**Status**: ‚úÖ **CONCLU√çDA COM SUCESSO!**

**O que foi implementado:**
- ‚úÖ Fun√ß√£o `SuperMDFe_Teste()` criada em mdfe 2.txt (linha ~4580)
- ‚úÖ Chamada redirecionada: linha 4745 de `SuperMDFe` ‚Üí `SuperMDFe_Teste`
- ‚úÖ DLL correta identificada e instalada (ST/StdCall)
- ‚úÖ Debug extensivo adicionado para troubleshooting

**üîß SOLU√á√ÉO PARA "Bad DLL calling convention":**

### ‚ùå PROBLEMA IDENTIFICADO:
Est√°vamos usando a **DLL ERRADA**:
- ‚ùå **ACBrMDFe32.dll MT/StdCall** (Multi-threaded) ‚Üí Causava erro "Bad DLL calling convention"
- ‚ùå **ACBrMDFe32.dll MT/Cdecl** (Multi-threaded, Cdecl) ‚Üí Incompat√≠vel com VB6

### ‚úÖ SOLU√á√ÉO APLICADA:
**Usar a DLL CORRETA**: `ACBrMDFe32.dll ST/StdCall` (Single-threaded, StdCall)

**Localiza√ß√£o da DLL correta:**
```
C:\Projetos\MDFe\NFE\ACBrLibMDFe-Windows-1.2.2.335\Windows\ST\StdCall\ACBrMDFe32.dll
```

**Comando usado para corre√ß√£o:**
```bash
cp "C:\Projetos\MDFe\NFE\ACBrLibMDFe-Windows-1.2.2.335\Windows\ST\StdCall\ACBrMDFe32.dll" "C:\Projetos\MDFe\NFE\ACBrMDFe32.dll"
```

### üìã TIPOS DE DLL DISPON√çVEIS:
```
ACBrLibMDFe-Windows-1.2.2.335\Windows\
‚îú‚îÄ‚îÄ MT\                    (Multi-threaded - N√ÉO funcionou)
‚îÇ   ‚îú‚îÄ‚îÄ Cdecl\            ‚ùå Incompat√≠vel com VB6
‚îÇ   ‚îî‚îÄ‚îÄ StdCall\          ‚ùå Causou "Bad DLL calling convention"
‚îî‚îÄ‚îÄ ST\                    (Single-threaded - FUNCIONOU!)
    ‚îú‚îÄ‚îÄ Cdecl\            ‚ö†Ô∏è N√£o testado
    ‚îî‚îÄ‚îÄ StdCall\          ‚úÖ SOLU√á√ÉO QUE FUNCIONOU!
```

**Teste implementado e funcionando:**
1. ‚úÖ Inicializa ACBr com DLL ST/StdCall
2. ‚úÖ Gera arquivo INI b√°sico  
3. ‚úÖ Carrega INI no ACBr
4. ‚úÖ Gera XML (1157 caracteres)
5. ‚úÖ Salva dados no banco + arquivo em \Temp\

**Resultado obtido:**
- ‚úÖ Mensagem: "TESTE ETAPA 1 CONCLU√çDO!"
- ‚úÖ XML gerado com sucesso (1157 chars)
- ‚úÖ Dados salvos no banco corretamente
- ‚úÖ Arquivo XML salvo em \Temp\ para verifica√ß√£o

---

## üìã PR√ìXIMAS ETAPAS {#proximas-etapas}
1. **ETAPA 2**: Migrar `TransmitirMDFe()` ap√≥s sucesso da Etapa 1
2. **ETAPA 3**: Migrar `RetornoMDFe()` ap√≥s sucesso da Etapa 2
3. **ETAPA 4**: Substituir fun√ß√µes originais pelas migradas
4. **ETAPA 5**: Testes integrados e homologa√ß√£o

---

## üóÑÔ∏è ESTRUTURA DO BANCO DE DADOS {#estrutura-banco}

### 1. Manifesto (Tabela Principal)
```sql
SELECT [Sequencia do manifesto], [Numero do manifesto], [Data de emiss√£o], 
       Uf, [Tipo de emitente], [Uf de descarregamento], Observa√ß√£o, Rntrc, 
       [Tipo de carroceria], [Uf do veiculo], [Tipo de rodado], Placa, Tara, 
       Renavam, [Capacidade kg], [Codigo do emitente], Transmitido, 
       [Nota cancelada], Autorizada, Historico, Proprietario, [Cpf Proprietario], 
       [Cnpj Proprietario], [Rntrc proprietario], [Nome Proprietario], 
       [Ie Proprietario], [Uf proprietario], [Tipo de proprietario], 
       [Tipo documento], [Numero do recibo], [Chave de acesso], XmlAssinado, 
       [Protocolo de autoriza√ß√£o], [Data e hora do mdfe], XmlAutorizado, 
       Encerrado, [Responsavel do seguro], [Tipo do responsavel], 
       [Documento do responsavel], [Nome da seguradora], [Cnpj da seguradora], 
       [N da apolice], [N averba√ß√£o], [Tipo de contratante], 
       [Documento do contratante], [Produto Predominante], 
       [Latitude de Carregamento], [Longitude de Carregamento], 
       [Latitude de Descrregamento], [Longitude de Descarregamento], 
       [CEP Carregamento], [CEP Descarregamento]
FROM Manifesto
```

### 2. Emitentes MDFe
```sql
SELECT [Sequencia do emitente], Cnpj, Ie, [Raz√£o social], [Nome fantasia], 
       Logradouro, Nro, Complemento, Bairro, [Codigo do ibge], Municipio, 
       Cep, Uf, Fone, Email, Inativo, [Certificado digital], [Chave flexdocs]
FROM [Emitentes mdfe]
```

---

## üìÅ ARQUIVOS ACBr ORGANIZADOS {#arquivos-acbr}

### ‚úÖ ARQUIVOS NECESS√ÅRIOS (no NFE.vbp):
- **ACBrMDFe.cls** - Classe principal do ACBr
- **ACBrMDFeUtils.bas** - Utilit√°rios para criar inst√¢ncias  
- **ACBrComum.bas** - Fun√ß√µes de convers√£o UTF-8
- **MDFeINIUtils.bas** - Utilit√°rios para criar INI
- **GerarINIMDFe.bas** - Fun√ß√µes auxiliares para INI

### ‚ùå ARQUIVOS REMOVIDOS (duplicatas):
- ~~ACBrComum_UTF8.bas~~ (duplicata)
- ~~MDFeINIUtils_UTF8.bas~~ (duplicata)  
- ~~GerarINIMDFe_UTF8.bas~~ (duplicata)

---

## üîß C√ìDIGO - ANTES/DEPOIS {#codigo}

### ‚ùå ANTES (FlexDocs - ATUAL):
```vb
Set objMDFEUtil = CreateObject("MDFe_Util.Util")
resultado = objMDFEUtil.infMunCarrega(codigo, municipio)
Consolidacao = objMDFEUtil.MDFe_NT2020001(...)
```

### ‚úÖ DEPOIS (ACBr - IMPLEMENTADO):
```vb
Set m_ACBrMDFe = CreateMDFe("", "")
m_ACBrMDFe.InicializarLib App.Path & "\ACBrLibMDFe.ini", ""
Call CriarMDFeINI(caminhoINI, ...)
m_ACBrMDFe.CarregarINI caminhoINI
m_ACBrMDFe.Assinar
xmlGerado = m_ACBrMDFe.ObterXml(0)
```

---

## üß™ TESTES A REALIZAR {#testes}

### ETAPA 1 - SuperMDFe():
**Como testar:**
1. Execute o sistema MDFe
2. Crie/edite um manifesto
3. Clique "Gerar MDFe"
4. Verifique mensagens nas observa√ß√µes
5. Confirme arquivos em \Temp\

**Se der erro:**
- Verificar se ACBrMDFE32.dll existe
- Conferir permiss√µes da pasta \Temp\
- Validar configura√ß√£o ACBrLibMDFe.ini

### FUNCIONALIDADES PENDENTES:
1. ‚ö†Ô∏è **SuperMDFe()** - EM TESTE (gera√ß√£o XML)
2. üìÖ **TransmitirMDFe()** - AGUARDANDO ETAPA 2
3. üìÖ **RetornoMDFe()** - AGUARDANDO ETAPA 3
4. üìÖ **CancelaMDFe()** - AGUARDANDO ETAPA 4
5. üìÖ **EncerraMDFe()** - AGUARDANDO ETAPA 5

---

## üìã CHAMADAS FLEXDOCS PARA MIGRA√á√ÉO {#chamadas-flexdocs}

### SuperMDFe() (ETAPA 1):
- `objMDFeUtil.infMunCarrega()` ‚Üí Arquivo INI
- `objMDFeUtil.CriaChaveDFe()` ‚Üí m_ACBrMDFe.GerarChave()
- `objMDFeUtil.MDFe_NT2020001()` ‚Üí CarregarINI + Assinar + ObterXml

### TransmitirMDFe() (ETAPA 2):
- `objMDFeUtil.EnviaMDFe()` ‚Üí m_ACBrMDFe.Enviar()

### RetornoMDFe() (ETAPA 3):
- `objMDFeUtil.BuscaMDFe()` ‚Üí m_ACBrMDFe.ConsultarRecibo()

---

## üö® REGRAS CR√çTICAS DA MIGRA√á√ÉO {#regras-criticas}

### ‚ùå NUNCA MODIFICAR ESTRUTURA DO BANCO:
- **JAMAIS** alterar nomes de campos
- **JAMAIS** alterar nomes de tabelas  
- **JAMAIS** adicionar/remover campos
- **SEMPRE** usar os campos EXATOS conforme tabelas.txt
- **Migra√ß√£o DEVE** ser apenas no c√≥digo, n√£o no banco

### üìã ESTRUTURA COMPLETA DO BANCO (OFICIAL)

**1. Condutores:**
```sql
SELECT [Sequencia do manifesto], [Nome condutor], [Cpf condutor]
FROM Codutores
```

**2. CTe da Carga:**
```sql
SELECT [Sequencia descarrega cte], [Sequencia do manifesto], [Chave do cte], 
       [Descri√ß√£o do municipio], [Valor total], [Peso bruto]
FROM [Cte da carga]
```

**3. NFe da Carga:**
```sql
SELECT [Sequencia descarrega], [Sequencia do manifesto], [Chave da nfe], 
       [Descri√ß√£o do municipio], [Valor total], [Peso bruto]
FROM [Nfe da carga]
```

**4. Munic√≠pios:**
```sql
SELECT [Sequencia do municipio], [Descri√ß√£o do municipio], Uf, [Codigo do ibge], 
       Cep, Inativo, Latitude, Longitude
FROM Municipios
```

**5. Manifesto (TABELA PRINCIPAL):**
```sql
SELECT [Sequencia do manifesto], [Numero do manifesto], [Data de emiss√£o], Uf, 
       [Tipo de emitente], [Uf de descarregamento], Observa√ß√£o, Rntrc, 
       [Tipo de carroceria], [Uf do veiculo], [Tipo de rodado], Placa, Tara, 
       Renavam, [Capacidade kg], [Codigo do emitente], Transmitido, 
       [Nota cancelada], Autorizada, Historico, Proprietario, [Cpf Proprietario], 
       [Cnpj Proprietario], [Rntrc proprietario], [Nome Proprietario], 
       [Ie Proprietario], [Uf proprietario], [Tipo de proprietario], 
       [Tipo documento], [Numero do recibo], [Chave de acesso], XmlAssinado, 
       [Protocolo de autoriza√ß√£o], [Data e hora do mdfe], XmlAutorizado, 
       Encerrado, [Responsavel do seguro], [Tipo do responsavel], 
       [Documento do responsavel], [Nome da seguradora], [Cnpj da seguradora], 
       [N da apolice], [N averba√ß√£o], [Tipo de contratante], 
       [Documento do contratante], [Produto Predominante], 
       [Latitude de Carregamento], [Longitude de Carregamento], 
       [Latitude de Descrregamento], [Longitude de Descarregamento], 
       [CEP Carregamento], [CEP Descarregamento]
FROM Manifesto
```

**6. Local de Carregamento:**
```sql
SELECT [Sequencia do manifesto], Sequencia, Uf, [Descri√ß√£o do municipio], 
       [Codigo do ibge]
FROM [Local de carregamento]
```

**7. Emitentes MDFe:**
```sql
SELECT [Sequencia do emitente], Cnpj, Ie, [Raz√£o social], [Nome fantasia], 
       Logradouro, Nro, Complemento, Bairro, [Codigo do ibge], Municipio, 
       Cep, Uf, Fone, Email, Inativo, [Certificado digital], [Chave flexdocs]
FROM [Emitentes mdfe]
```

**8. Descarregamento NFe:**
```sql
SELECT [Sequencia descarrega], [Sequencia do manifesto], [Codigo do ibge], 
       [Descri√ß√£o do municipio]
FROM [Descarregamento nfe]
```

**9. Descarregamento CTe:**
```sql
SELECT [Sequencia descarregamento cte], [Sequencia do manifesto], 
       [Codigo do ibge], [Descri√ß√£o do municipio]
FROM [Descarregamento cte]
```

**10. UF de Percurso:**
```sql
SELECT [Sequencia do manifesto], Sequencia, Uf
FROM [Uf de percurso]
```

## ‚ö†Ô∏è IMPORTANTE - SITUA√á√ÉO ATUAL:
- **Sistema ainda usa FlexDocs** em produ√ß√£o
- **Teste ACBr implementado** mas n√£o ativado por padr√£o  
- **Migra√ß√£o incremental** para evitar quebrar funcionamento
- **Backup autom√°tico** - fun√ß√£o original preservada
- **ESTRUTURA DO BANCO**: Intoc√°vel e imut√°vel

---

## üîß INFORMA√á√ïES T√âCNICAS PARA CONTINUIDADE {#info-tecnicas}

### üìç LOCALIZA√á√ÉO DAS MODIFICA√á√ïES:
- **Arquivo principal**: `mdfe 2.txt`
- **Fun√ß√£o de teste**: `SuperMDFe_Teste()` - linha 8617
- **Chamada redirecionada**: linha 4745 (`SuperMDFe` ‚Üí `SuperMDFe_Teste`)
- **Projeto VB6**: `NFE.vbp` (atualizado com m√≥dulos corretos)

### üõ†Ô∏è DEPEND√äNCIAS VERIFICADAS:
- ‚úÖ **ACBrMDFE32.dll** - Biblioteca principal (deve estar no PATH)
- ‚úÖ **ACBrLibMDFe.ini** - Configura√ß√£o ACBr (RS, Homologa√ß√£o)
- ‚úÖ **ACBrMDFe.cls** - Classe wrapper VB6
- ‚úÖ **ACBrMDFeUtils.bas** - Fun√ß√µes CreateMDFe()
- ‚úÖ **MDFeINIUtils.bas** - Fun√ß√µes CriarMDFeINI(), AdicionarEmitente(), etc.

### üîÑ COMO REVERTER SE NECESS√ÅRIO:
```vb
' Para voltar ao FlexDocs temporariamente, alterar linha 4745:
' DE: SuperMDFe_Teste ' ETAPA 1: Testando migra√ß√£o ACBr
' PARA: SuperMDFe
```

### üìã TROUBLESHOOTING:
**Se der erro "Object not found" ou "DLL not found":**
1. Verificar se `ACBrMDFE32.dll` est√° na pasta do sistema
2. Registrar DLL: `regsvr32 ACBrMDFE32.dll`
3. Verificar permiss√µes da pasta `\Temp\`

**Se der erro "Bad DLL calling convention":**
1. Problema na inicializa√ß√£o ACBr
2. Verificar se `ACBrLibMDFe.ini` existe
3. Tentar executar como Administrador

**Se XML n√£o for gerado:**
1. Verificar dados obrigat√≥rios (CNPJ, UF, etc.)
2. Conferir se fun√ß√µes INI est√£o sendo chamadas
3. Validar arquivo INI criado em `\Temp\`

### üìä LOGS E DEPURA√á√ÉO:
- **Observa√ß√µes do Manifesto**: Cont√©m progresso detalhado
- **Arquivos tempor√°rios**: `\Temp\MDFe_Teste_*.ini` e `\Temp\MDFe_Teste_XML_*.xml`
- **Mensagem final**: "TESTE ETAPA 1 CONCLU√çDO!" (se sucesso)

### üéØ CRIT√âRIOS DE SUCESSO ETAPA 1:
1. ‚úÖ Sistema inicializa sem erro
2. ‚úÖ Mensagem "TESTE ETAPA 1" aparece nas observa√ß√µes  
3. ‚úÖ Arquivo INI √© criado em \Temp\
4. ‚úÖ XML √© gerado com tamanho > 100 caracteres
5. ‚úÖ Dados s√£o salvos no banco (Chave de acesso + XmlAssinado)
6. ‚úÖ Mensagem final de sucesso √© exibida

---

## üìã RESUMO EXECUTIVO

### üéØ SITUA√á√ÉO ATUAL:
**ETAPA 1 IMPLEMENTADA - AGUARDANDO TESTE**

### ‚ö° A√á√ÉO NECESS√ÅRIA:
1. **EXECUTAR O SISTEMA MDFe**
2. **CRIAR/GERAR UM MANIFESTO** 
3. **VERIFICAR SE APARECE "TESTE ETAPA 1"**

### üîÑ PR√ìXIMO PASSO:
- **SE SUCESSO**: Avan√ßar para Etapa 2 (TransmitirMDFe)
- **SE ERRO**: Analisar logs e corrigir

### üìû PARA CONTINUIDADE:
**Comando**: "Olhe o claude.md" - Esta documenta√ß√£o cont√©m TUDO necess√°rio para continuar a migra√ß√£o.

---
*Documenta√ß√£o atualizada em: Janeiro 2025*
*Status: Etapa 1 pronta para teste*